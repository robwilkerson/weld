name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        go-version: ['1.21']
    runs-on: ${{ matrix.os }}
    env:
      CGO_ENABLED: 1
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
        cache: false  # Disable Go module cache to avoid tar issues
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    # Linux specific setup
    - name: Install Linux dependencies
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        
        # Install basic dependencies
        sudo apt-get install -y libgtk-3-dev pkg-config
        
        # Try to install both webkit versions for compatibility
        echo "Attempting to install webkit packages..."
        if ! sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev; then
          echo "Failed to install both webkit versions, trying 4.1 only..."
          sudo apt-get install -y libwebkit2gtk-4.1-dev
        fi
        
        # List available webkit packages
        echo "Available webkit packages:"
        apt list --installed | grep webkit || echo "No webkit packages found"
        
        # Check pkg-config files
        echo "Available webkit pkg-config files:"
        ls -la /usr/lib/x86_64-linux-gnu/pkgconfig/ | grep webkit || echo "No webkit .pc files found"
        
        # Create symlink for webkit2gtk-4.0 pointing to 4.1 if 4.0 is not available
        if [ ! -f /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc ]; then
          echo "Creating webkit2gtk-4.0.pc symlink..."
          sudo ln -s /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc || true
        fi
        
        # Verify webkit setup
        echo "Verifying webkit setup:"
        pkg-config --exists webkit2gtk-4.0 && echo "webkit2gtk-4.0: OK" || echo "webkit2gtk-4.0: MISSING"
        pkg-config --exists webkit2gtk-4.1 && echo "webkit2gtk-4.1: OK" || echo "webkit2gtk-4.1: MISSING"
        
        # Set CGO environment for better webkit compatibility
        export CGO_ENABLED=1
        export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH"
        
        echo "Set CGO_ENABLED=1 and PKG_CONFIG_PATH for webkit"
    
    # Install Wails (Linux/macOS)
    - name: Install Wails (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.10.1
    
    # Install Wails (Windows)
    - name: Install Wails (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        Write-Host "Installing Wails on Windows..."
        try {
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.10.1
          Write-Host "Wails installation completed"
          
          # Verify installation
          $wailsPath = Get-Command wails -ErrorAction Stop
          Write-Host "Wails installed at: $($wailsPath.Source)"
          
          # Show version
          wails version
        } catch {
          Write-Host "Wails installation failed: $_"
          Write-Host "Go environment:"
          go env
          throw "Failed to install Wails"
        }
    
    # Verify Wails installation (Linux/macOS)
    - name: Wails Doctor (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        echo "Running wails doctor..."
        wails doctor
        
        # Additional verification for Linux
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          echo "Linux-specific checks:"
          echo "CGO_ENABLED: $CGO_ENABLED"
          echo "pkg-config webkit2gtk-4.0 check:"
          pkg-config --modversion webkit2gtk-4.0 || echo "webkit2gtk-4.0 not found"
          echo "pkg-config webkit2gtk-4.1 check:"
          pkg-config --modversion webkit2gtk-4.1 || echo "webkit2gtk-4.1 not found"
        fi
    
    # Verify Wails installation (Windows)
    - name: Wails Doctor (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        Write-Host "Running wails doctor on Windows..."
        try {
          wails doctor
          Write-Host "Wails doctor completed successfully"
        } catch {
          Write-Host "Wails doctor failed with error: $_"
          Write-Host "Checking Wails installation..."
          
          # Check if wails is in PATH
          try {
            $wailsPath = Get-Command wails -ErrorAction Stop
            Write-Host "Wails found at: $($wailsPath.Source)"
          } catch {
            Write-Host "Wails not found in PATH"
          }
          
          # Check Go installation
          try {
            go version
            Write-Host "Go is working"
          } catch {
            Write-Host "Go is not working: $_"
          }
          
          # Show environment info
          Write-Host "Environment variables:"
          Write-Host "GOPATH: $env:GOPATH"
          Write-Host "GOROOT: $env:GOROOT"
          Write-Host "PATH: $env:PATH"
          
          throw "Wails doctor failed"
        }
    
    # Frontend dependencies
    - name: Install frontend dependencies
      working-directory: frontend
      run: bun install
    
    # Build frontend (required for go:embed)
    # The main.go file uses //go:embed all:frontend/dist to embed the frontend
    # assets into the binary. This requires the dist directory to exist at
    # compile time, so we must build the frontend before running Go tests.
    - name: Build frontend
      working-directory: frontend
      run: bun run build
    
    # Backend tests
    - name: Run backend tests
      run: go test ./... -v -cover
    
    # Frontend tests
    - name: Run frontend tests
      working-directory: frontend
      run: bun run test:coverage
    
    # Install Playwright browsers for E2E tests (skip for now)
    - name: Install Playwright browsers
      if: false
      working-directory: frontend
      run: bunx playwright install --with-deps chromium
    
    # Start Wails dev server in background for E2E tests
    - name: Start Wails dev server (Linux/macOS)
      if: false
      run: |
        echo "Starting Wails dev server..."
        echo "Go version: $(go version)"
        echo "Wails version: $(wails version)"
        
        # Check if frontend build exists
        if [ ! -d "frontend/dist" ]; then
          echo "Frontend dist directory not found, building..."
          cd frontend && bun run build && cd ..
        fi
        
        # Try a quick compilation test first (Linux only)
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          echo "Testing Wails compilation on Linux..."
          echo "Available webkit libraries:"
          find /usr/lib -name "*webkit*" 2>/dev/null | head -10
          echo "pkg-config test:"
          pkg-config --cflags --libs webkit2gtk-4.0 || echo "webkit2gtk-4.0 pkg-config failed"
          
          echo "CGO environment:"
          echo "CGO_ENABLED: ${CGO_ENABLED:-not set}"
          echo "CGO_CFLAGS: ${CGO_CFLAGS:-not set}"
          echo "CGO_LDFLAGS: ${CGO_LDFLAGS:-not set}"
          
          if ! timeout 45 wails build -nsis=false -debug > build-test.log 2>&1; then
            echo "WARNING: Wails build test failed, but continuing anyway..."
            echo "Build log (last 50 lines):"
            tail -50 build-test.log
            
            echo "Checking for webkit issues:"
            grep -i "webkit" build-test.log | head -10 || echo "No webkit errors found"
            
            echo "Checking for CGO issues:"
            grep -i "cgo\|gcc\|clang" build-test.log | head -10 || echo "No CGO errors found"
            
            echo "NOTE: Dev server may fail due to compilation issues"
          else
            echo "Wails build test successful"
          fi
        fi
        
        echo "Starting wails dev server..."
        wails dev > wails.log 2>&1 &
        WAILS_PID=$!
        echo $WAILS_PID > wails.pid
        
        # Give it a moment to start
        sleep 5
        
        # Check if process is still running
        if ! ps -p $WAILS_PID > /dev/null; then
          echo "ERROR: Wails dev server died immediately"
          echo "Wails log contents:"
          cat wails.log
          exit 1
        fi
        
        # Wait for dev server to be ready
        timeout=60
        while ! curl -s http://localhost:34115 > /dev/null && [ $timeout -gt 0 ]; do
          sleep 1
          timeout=$((timeout - 1))
          if [ $((60 - timeout)) -eq 15 ]; then
            echo "Still waiting for Wails dev server (15s elapsed)..."
            echo "Last 20 lines of wails.log:"
            tail -20 wails.log || echo "No log output yet"
          fi
          if [ $((60 - timeout)) -eq 30 ]; then
            echo "Still waiting for Wails dev server (30s elapsed)..."
            echo "Checking if process is still alive:"
            ps -p $WAILS_PID || echo "Process died"
            echo "Last 30 lines of wails.log:"
            tail -30 wails.log || echo "No log output yet"
          fi
        done
        
        if [ $timeout -eq 0 ]; then
          echo "Wails dev server failed to start after 60 seconds"
          echo "Full wails.log contents:"
          cat wails.log
          echo "System info:"
          echo "OS: $(uname -a)"
          echo "Available ports:"
          netstat -tuln | grep :34115 || echo "Port 34115 not found"
          
          # On Linux, show additional library info
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "Library dependencies:"
            ldd $(which wails) 2>&1 || echo "Could not check wails dependencies"
          fi
          
          exit 1
        fi
        echo "Wails dev server is ready"
    
    
    # Run E2E tests (skip for now)
    - name: Run E2E tests
      if: false
      working-directory: frontend
      run: bun run test:e2e
      env:
        CI: true
    
    # Stop Wails dev server (Linux/macOS)
    - name: Stop Wails dev server (Linux/macOS)
      if: false
      run: |
        if [ -f wails.pid ]; then
          kill $(cat wails.pid) || true
          rm wails.pid
        fi
    
    
    # Upload E2E test results on failure (skip for now)
    - name: Upload E2E test results
      if: false
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-results-${{ matrix.os }}
        path: |
          frontend/tests/e2e/test-results/
          frontend/tests/e2e/playwright-report/
        retention-days: 7
    
    # Build the application
    - name: Build application
      run: wails build
    
    # Ad-hoc sign macOS app to prevent "damaged app" error
    - name: Ad-hoc Sign macOS App
      if: matrix.os == 'macos-latest'
      run: |
        echo "Cleaning extended attributes from Weld.app..."
        xattr -cr build/bin/Weld.app
        echo "Ad-hoc signing Weld.app..."
        codesign --force --deep --sign - build/bin/Weld.app
        echo "Verifying signature..."
        codesign --verify --verbose build/bin/Weld.app
      shell: bash
    
    # Upload artifacts (optional - for debugging)
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: weld-${{ matrix.os }}
        path: |
          build/bin/*
        retention-days: 7